<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>SolarAI | ì‹¤ì‹œê°„ ì§„ë‹¨</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <!-- HEADER ìŠ¤í¬ë¡¤ì— ë”°ë¼ ë‚´ë ¤ê°€ê¸° -->
    <header class="nav sticky-header">
      <div class="logo">
        <a href="/" class="home-link" onclick="resetArduino()">
          <img src="/static/home_dark.png" class="home-icon" />
        </a>
      </div>

      <nav class="nav-buttons">
        <a href="/image" class="nav-btn" onclick="resetArduino()"
          >ì´ë¯¸ì§€ ì§„ë‹¨</a
        >
        <a href="/live" class="nav-btn active">ì‹¤ì‹œê°„ ì§„ë‹¨</a>
      </nav>
    </header>

    <!-- HERO -->
    <section
      class="hero sub-hero"
      style="background-image: url(&quot;/static/card_live.jpg&quot;)"
    >
      <div class="hero-inner">
        <div class="hero-text">
          <h1>ì‹¤ì‹œê°„ ì›¹ìº  ëª¨ë‹ˆí„°ë§</h1>
          <p>
            ì›¹ìº ì„ í†µí•´ íƒœì–‘ê´‘ íŒ¨ë„ ìƒíƒœë¥¼<br />
            ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.
          </p>
          <a href="/intro" class="hero-home-btn" onclick="resetArduino()"
            >ì‚¬ìš©ë°©ë²•</a
          >
        </div>
      </div>
    </section>

    <!-- BODY -->
    <main class="page-content">
      <section class="detect-section">
        <!-- ì¢Œì¸¡: ì›¹ìº  -->
        <div class="upload-panel">
          <h2>ì‹¤ì‹œê°„ ì¹´ë©”ë¼</h2>
          <p class="desc">
            ì—°ê²°ëœ ì¹´ë©”ë¼ë¥¼ í†µí•´ íƒœì–‘ê´‘ íŒ¨ë„ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
          </p>

          <div class="camera-box">
            <div id="cameraStatus" class="camera-status loading">
              ğŸ“· ì¹´ë©”ë¼ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...
            </div>

            <!-- ğŸ”¥ ì´ê²Œ ìˆì–´ì•¼ gen_frames() ì‹¤í–‰ -->
            <img
              id="cameraStream"
              src="{{ url_for('video_feed') }}"
              width="800"
              height="500"
              style="display: none"
            />
          </div>

          <p class="note">â€» AI ì„±ëŠ¥ì— ë”°ë¼ ì˜¤ì°¨ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

          <p id="arduinoState" class="note" style="font-weight: bold">
            ğŸ”” Arduino ìƒíƒœ: í™•ì¸ ì¤‘...
          </p>

          <p class="note">
            âŒ¨ï¸ ë‹¨ì¶•í‚¤: <b>S</b> = ê²½ê³  ì¤‘ì§€ / <b>R</b> = ê²½ê³  ì¬ê°œ
          </p>
        </div>

        <!-- ìš°ì¸¡: ê²°ê³¼ -->
        <div class="result-panel">
          <h2>íƒì§€ ê²°ê³¼</h2>
          <p class="desc">í•­ëª©ë³„ ì‹ ë¢°ë„</p>
          <div class="match-metrics" id="matchMetrics"></div>
          <p class="note">â€» ì •í™•ë„ í‰ê· ì¹˜ì´ë¯€ë¡œ ì˜¤ì°¨ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="footer-inner">
        <div>
          <strong>SolarAI</strong>
          <p>Â©2025 SolarAI. All rights reserved.</p>
          <p>ì£¼ì†Œ : ì„œìš¸íŠ¹ë³„ì‹œ ì€í‰êµ¬ ì€í‰ë¡œ3ê°€ê¸¸ 29-2</p>
          <p>Tel : 02-5014-2907</p>
          <div>
            <a>ì´ìš©ì•½ê´€ | </a>
            <a>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ | </a>
            <a>ë¬¸ì˜í•˜ê¸°</a>
          </div>
        </div>
      </div>
    </footer>

    <!-- ================= SCRIPT ================= -->

    <script>
      /* ===== ìƒ‰ìƒ ===== */
      function getColor(p) {
        if (p >= 80) return "#22c55e";
        if (p >= 50) return "#facc15";
        return "#ef4444";
      }

      /* ===== ì‹¤ì‹œê°„ í†µê³„ í‘œì‹œìš© (í‘œì‹œë§Œ í•¨, ì œì–´ âŒ) ===== */
      function updateMetrics(data) {
        const box = document.getElementById("matchMetrics");
        box.innerHTML = "";

        const entries = Object.entries(data);
        if (entries.length === 0) {
          box.innerHTML = "<p style='color:#777'>íƒì§€ ê²°ê³¼ ì—†ìŒ</p>";
          return;
        }

        entries.forEach(([cls, item]) => {
          const percent = item.percent ?? 0;
          const count = item.count ?? 0;
          const rounded = Math.round(percent);

          box.innerHTML += `
      <div class="metric">
        <div class="metric-label">
          <span>${cls}</span>
          <span>${rounded}% (${count}ê±´)</span>
        </div>
        <div class="metric-bar">
          <div class="metric-fill"
               style="width:${rounded}%; background:${getColor(rounded)};">
          </div>
        </div>
      </div>
    `;
        });
      }

      /* ===== 1ì´ˆë§ˆë‹¤ í†µê³„ í‘œì‹œë§Œ ===== */
      setInterval(() => {
        fetch("/defect_stats")
          .then((res) => res.json())
          .then((data) => updateMetrics(data))
          .catch(() => {});
      }, 1000);
    </script>

    <script>
      /* ===== ì¹´ë©”ë¼ ìƒíƒœ í‘œì‹œ ===== */
      const camImg = document.getElementById("cameraStream");
      const camStatus = document.getElementById("cameraStatus");

      const camTimeout = setTimeout(() => {
        camStatus.innerText = "ğŸ“· ì¹´ë©”ë¼ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...";
        camStatus.className = "camera-status error";
      }, 20000);

      camImg.onload = () => {
        clearTimeout(camTimeout);
        camStatus.style.display = "none";
        camImg.style.display = "block";
      };
    </script>

    <script>
      /* ===== Arduino ìƒíƒœ í‘œì‹œ (í‘œì‹œìš©ë§Œ, ì œì–´ âŒ) ===== */
      function updateArduinoStatus() {
        fetch("/arduino_status")
          .then((res) => res.json())
          .then((data) => {
            const el = document.getElementById("arduinoState");
            el.innerText = data.enabled
              ? "ğŸ”” Arduino ìƒíƒœ: í™œì„±í™”"
              : "ğŸ”• Arduino ìƒíƒœ: ì¤‘ì§€ë¨";
          })
          .catch(() => {});
      }

      setInterval(updateArduinoStatus, 1000);
      updateArduinoStatus();
    </script>

    <script>
      /* ===== í‚¤ë³´ë“œ ì œì–´ ===== */
      document.addEventListener("keydown", (e) => {
        if (e.key === "s" || e.key === "S") {
          fetch("/arduino_enable", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enabled: false }),
          });
        }
        if (e.key === "r" || e.key === "R") {
          fetch("/arduino_enable", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ enabled: true }),
          });
        }
      });
    </script>

    <script>
      /* ===== í˜ì´ì§€ ì´ë™ ì‹œë§Œ OFF ===== */
      function resetArduino() {
        fetch("/arduino_reset", { method: "POST" });
      }
    </script>
  </body>
</html>
