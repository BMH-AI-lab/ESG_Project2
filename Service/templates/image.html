<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>SolarAI | ì´ë¯¸ì§€ ì§„ë‹¨</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <!-- HEADER ìŠ¤í¬ë¡¤ì— ë”°ë¼ ë‚´ë ¤ê°€ê¸° -->
    <header class="nav sticky-header">
      <div class="logo">
        <a href="/" class="home-link" onclick="resetArduino()">
          <img src="/static/home_dark.png" class="home-icon" />
        </a>
      </div>
      <nav class="nav-buttons">
        <a href="/image" class="nav-btn active">ì´ë¯¸ì§€ ì§„ë‹¨</a>
        <a href="/live" class="nav-btn" onclick="resetArduino()">ì‹¤ì‹œê°„ ì§„ë‹¨</a>
      </nav>
    </header>

    <section
      class="hero sub-hero"
      style="background-image: url(&quot;/static/card_image.jpg&quot;)"
    >
      <div class="hero-inner">
        <div class="hero-text">
          <h1>íƒœì–‘ê´‘ íŒ¨ë„ ì´ë¯¸ì§€ ì •ë°€ ë¶„ì„</h1>
          <p>
            ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬<br />íƒœì–‘ê´‘ íŒ¨ë„ì˜ ìƒíƒœë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.
          </p>
          <a href="/intro" class="hero-home-btn" onclick="resetArduino()"
            >ì‚¬ìš©ë°©ë²•</a
          >
        </div>
      </div>
    </section>

    <main class="page-content">
      <section class="detect-section">
        <div class="upload-panel">
          <h2>ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
          <p class="desc">
            íƒœì–‘ê´‘ íŒ¨ë„ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ AIê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.
          </p>

          <input type="file" id="imageInput" accept="image/*" hidden multiple />
          <input
            type="file"
            id="folderInput"
            accept="image/*"
            hidden
            webkitdirectory
            directory
            multiple
          />

          <label class="upload-box" id="drop-zone" for="imageInput">
            <div class="upload-inner">
              <span class="upload-icon">ğŸ“·</span>
              <strong>ì´ë¯¸ì§€ / í´ë” ì„ íƒ</strong>
              <p>í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ (ì´ë¯¸ì§€Â·í´ë” ê°€ëŠ¥)</p>
            </div>
          </label>

          <p id="notice" class="note" style="font-weight: bold"></p>
        </div>

        <div class="result-panel">
          <h2>íƒì§€ ê²°ê³¼</h2>
          <p class="desc">ìœ í˜•ë³„ ì •í™•ë„ ë° íƒì§€ ìˆ˜</p>
          <div class="match-metrics" id="metrics"></div>
        </div>

        <div class="result-image-large">
          <img id="resultImgTag" />
          <p class="note" id="resultNote">ğŸ“· ì´ë¯¸ì§€ íƒì§€ ê²°ê³¼ ì‚¬ì§„</p>
          <div id="analysisArea" class="analysis-area"></div>
        </div>

        <div class="history-row">
          <h3>Analyzed Images</h3>
          <div class="image-list" id="imageList"></div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        <div>
          <strong>SolarAI</strong>
          <p>Â©2025 SolarAI. All rights reserved.</p>
          <p>ì£¼ì†Œ : ì„œìš¸íŠ¹ë³„ì‹œ ì€í‰êµ¬ ì€í‰ë¡œ3ê°€ê¸¸ 29-2</p>
          <p>Tel : 02-5014-2907</p>
          <div>
            <a>ì´ìš©ì•½ê´€ | </a>
            <a>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ | </a>
            <a>ë¬¸ì˜í•˜ê¸°</a>
          </div>
        </div>
      </div>
    </footer>

    <script>
      /* ================= íƒ€ì´í•‘ íš¨ê³¼ ================= */
      function typeWriter(element, text, speed = 18) {
        element.innerHTML = "";
        let i = 0;

        function typing() {
          if (i < text.length) {
            element.innerHTML += text[i] === "\n" ? "<br>" : text[i];
            i++;
            setTimeout(typing, speed);
          }
        }
        typing();
      }

      /* ================= ì„¤ì • ================= */
      const CLASS_ORDER = [
        "Anomaly Solar Panel",
        "Normal Solar Panel",
        "Snow",
        "Structural Damage",
        "Surface Contaminant", // n ëª¨ë¸ ì‚¬ìš©ì‹œ s ì¶”ê°€
      ];

      const imageInput = document.getElementById("imageInput");
      const folderInput = document.getElementById("folderInput");
      const dropZone = document.getElementById("drop-zone");

      const resultImg = document.getElementById("resultImgTag");
      const resultNote = document.getElementById("resultNote");
      const analysisArea = document.getElementById("analysisArea");
      const metricsBox = document.getElementById("metrics");
      const notice = document.getElementById("notice");
      const imageList = document.getElementById("imageList");

      let lastImageURL = null;
      const imageResultCache = {};

      /* âœ… Gemini ë¶„ì„ ê²°ê³¼ ìºì‹œ (ì´ë¯¸ì§€ë³„) */
      const geminiResultCache = {};

      /* ================= ğŸ”´ ì¶”ê°€ëœ ìœ ì¼í•œ í•¨ìˆ˜ ================= */
      function updateNoticeByStats(stats) {
        if (!stats) return;

        const hasAnomaly = Object.entries(stats).some(
          ([cls, item]) => cls !== "Normal Solar Panel" && item.count > 0,
        );

        if (hasAnomaly) {
          notice.innerText = "ğŸš¨ ì´ìƒ íƒì§€ë¨ Â· ì´ìƒ ìƒíƒœì…ë‹ˆë‹¤";
          notice.style.color = "#dc2626";
        } else {
          notice.innerText = "âœ… ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤";
          notice.style.color = "#16a34a";
        }
      }

      /* ================= ìœ í‹¸ ================= */
      function isImageFile(file) {
        return file && file.type && file.type.startsWith("image/");
      }

      function getColor(p) {
        if (p >= 80) return "#22c55e";
        if (p >= 50) return "#facc15";
        return "#ef4444";
      }

      function renderMetrics(stats = {}) {
        metricsBox.innerHTML = "";
        CLASS_ORDER.forEach((cls) => {
          const item = stats[cls] || { percent: 0, count: 0 };
          const p = Math.round(item.percent || 0);
          metricsBox.innerHTML += `
      <div class="metric">
        <div class="metric-label">
          <span>${cls}</span>
          <span>${p}% (${item.count}ê±´)</span>
        </div>
        <div class="metric-bar">
          <div class="metric-fill" style="width:${p}%; background:${getColor(p)};"></div>
        </div>
      </div>
    `;
        });
      }

      function showAnalyzeButton() {
        analysisArea.innerHTML = "";

        const btn = document.createElement("button");
        btn.className = "analysis-btn";
        btn.innerText = "íƒì§€ ê²°ê³¼ ë¶„ì„í•˜ê¸°";
        btn.onclick = analyzeCurrentImage;

        analysisArea.appendChild(btn);
      }

      function hideAnalyzeButton() {
        analysisArea.innerHTML = "";
      }

      /* âœ… ì„ íƒ ì´ë¯¸ì§€ ë³€ê²½ ì‹œ: Gemini UI ì´ˆê¸°í™” + ìºì‹œ ìˆìœ¼ë©´ ì¦‰ì‹œ í‘œì‹œ */
      function resetGeminiUIForImage(imgURL) {
        hideAnalyzeButton();

        if (geminiResultCache[imgURL]) {
          showGeminiResult(geminiResultCache[imgURL], true);
        } else {
          showAnalyzeButton();
        }
      }

      /* ================= í´ë” ì¬ê·€ ì²˜ë¦¬ ================= */
      function readAllEntries(reader) {
        return new Promise((resolve) => {
          const entries = [];
          const read = () => {
            reader.readEntries((batch) => {
              if (!batch.length) return resolve(entries);
              entries.push(...batch);
              read();
            });
          };
          read();
        });
      }

      async function traverseEntry(entry, outFiles) {
        if (entry.isFile) {
          await new Promise((resolve) => {
            entry.file((file) => {
              if (isImageFile(file)) outFiles.push(file);
              resolve();
            });
          });
        } else if (entry.isDirectory) {
          const reader = entry.createReader();
          const entries = await readAllEntries(reader);
          for (const e of entries) {
            await traverseEntry(e, outFiles);
          }
        }
      }

      function updateHistoryVisibility() {
        const historyRow = document.querySelector(".history-row");
        if (!historyRow) return;

        if (imageList.children.length === 0) {
          historyRow.classList.remove("show");
        }
      }

      /* ================= íƒì§€ ================= */
      async function detectImage(file, isMain = false) {
        const formData = new FormData();
        formData.append("image", file);

        const res = await fetch("/detect-image", {
          method: "POST",
          body: formData,
        });
        const blob = await res.blob();
        const imgURL = URL.createObjectURL(blob);

        const stats = await (await fetch("/image_defect_stats")).json();
        imageResultCache[imgURL] = stats;

        // ğŸ”¥ ë©”ì¸ ì´ë¯¸ì§€ë„ ëˆ„ì  ì´ë¯¸ì§€ì— ì¶”ê°€
        const card = document.createElement("div");
        card.className = "image-card";
        card.dataset.img = imgURL;
        card.innerHTML = `
          <button class="delete-btn">âœ•</button>
          <img src="${imgURL}">
        `;

        card.querySelector("img").onclick = () => {
          /* âœ… ì„ íƒ ì´ë¯¸ì§€ ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœ ì •ë¦¬ */
          lastImageURL = imgURL;
          resultImg.src = imgURL;
          resultImg.style.display = "block";
          resultNote.style.display = "none";
          const stats = imageResultCache[imgURL];
          renderMetrics(stats);

          // âœ… ì—¬ê¸° ì¶”ê°€
          updateNoticeByStats(stats);

          /* âœ… Gemini: ìºì‹œ ìˆìœ¼ë©´ â€œì´ë¯¸ ë¶„ì„ë¨â€ í‘œì‹œ, ì—†ìœ¼ë©´ ë²„íŠ¼ ì¬ìƒì„± */
          resetGeminiUIForImage(imgURL);
        };

        card.querySelector(".delete-btn").onclick = (e) => {
          e.stopPropagation();
          delete imageResultCache[imgURL];

          /* âœ… Gemini ìºì‹œë„ í•¨ê»˜ ì‚­ì œ */
          delete geminiResultCache[imgURL];

          card.remove();
          updateHistoryVisibility(); // â­ ì´ ì¤„ ì¶”ê°€

          /* (ì„ íƒ) ì‚­ì œí•œ ì´ë¯¸ì§€ê°€ í˜„ì¬ ì„ íƒ ì´ë¯¸ì§€ë©´ UI ì •ë¦¬ */
          if (lastImageURL === imgURL) {
            lastImageURL = null;
            hideAnalyzeButton();
            analysisArea.innerHTML = "";
          }
        };

        imageList.appendChild(card);
        document.querySelector(".history-row").classList.add("show");

        if (isMain) {
          lastImageURL = imgURL;
          resultImg.src = imgURL;
          resultImg.style.display = "block";
          resultNote.style.display = "none";
          renderMetrics(stats);

          /* âœ… ë©”ì¸ ì´ë¯¸ì§€ë„ ìºì‹œ ì—¬ë¶€ì— ë”°ë¼ ë²„íŠ¼/ê²°ê³¼ í‘œì‹œ */
          resetGeminiUIForImage(imgURL);

          const hasAnomaly = Object.entries(stats).some(
            ([cls, item]) => cls !== "Normal Solar Panel" && item.count > 0,
          );

          notice.innerText = hasAnomaly
            ? "ğŸš¨ ì´ìƒ íƒì§€ë¨ Â· ë¶€ì €ê°€ 3ì´ˆê°„ ë™ì‘í•©ë‹ˆë‹¤"
            : "âœ… ì •ìƒ ìƒíƒœì…ë‹ˆë‹¤";
          updateNoticeByStats(stats);
          notice.style.color = hasAnomaly ? "#dc2626" : "#16a34a";
        }
      }

      /* ================= íŒŒì¼ ì²˜ë¦¬ ================= */
      async function processFiles(files) {
        const imgs = files.filter(isImageFile);
        if (!imgs.length) {
          notice.innerText = "â—ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.";
          notice.style.color = "#dc2626";
          return;
        }

        notice.innerText = `ğŸ” ì´ë¯¸ì§€ ë¶„ì„ ì¤‘... (${imgs.length}ì¥)`;
        notice.style.color = "#555";

        let first = true;
        for (const f of imgs) {
          await detectImage(f, first);
          first = false;
        }
      }

      /* ================= Gemini ë¶„ì„ ================= */
      async function analyzeCurrentImage() {
        if (!lastImageURL || !imageResultCache[lastImageURL]) return;

        /* âœ… ì´ë¯¸ ë¶„ì„ëœ ì´ë¯¸ì§€ë©´: Gemini ì¬í˜¸ì¶œ ì—†ì´ ìºì‹œ ì‚¬ìš© */
        if (geminiResultCache[lastImageURL]) {
          showGeminiResult(geminiResultCache[lastImageURL], true);
          return;
        }

        const stats = imageResultCache[lastImageURL];

        // ë¡œë”© í‘œì‹œ
        analysisArea.innerHTML = "<p>ğŸ§  AI ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>";

        const res = await fetch("/analyze-gemini", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ stats }),
        });

        const data = await res.json();

        /* âœ… ìºì‹± */
        geminiResultCache[lastImageURL] = data.report;

        showGeminiResult(data.report, false);
      }

      function showGeminiResult(text, fromCache = false) {
        analysisArea.innerHTML = `
    <div class="gemini-report">
      <div class="report-header">
        <span class="badge-ai">AI Report</span>
        ${fromCache ? `<span class="badge-cached">ì´ë¯¸ ë¶„ì„ë¨</span>` : ``}
        <h3>Gemini ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼</h3>
      </div>
      
      <div class="report-body">
        <pre id="geminiText"></pre>
      </div>
    </div>
  `;

        const pre = document.getElementById("geminiText");

        if (fromCache) {
          pre.innerText = text;
        } else {
          typeWriter(pre, text, 18);
        }
      }

      /* ================= input ================= */
      imageInput.addEventListener("change", async () => {
        await processFiles(Array.from(imageInput.files || []));
        imageInput.value = "";
      });

      folderInput.addEventListener("change", async () => {
        await processFiles(Array.from(folderInput.files || []));
        folderInput.value = "";
      });

      /* ================= Drag & Drop ================= */
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("drag-over");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("drag-over");
      });

      dropZone.addEventListener("drop", async (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");

        const dt = e.dataTransfer;
        const collected = [];

        // 1ï¸âƒ£ filesëŠ” ë¬´ì¡°ê±´ ìˆ˜ì§‘ (ì—¬ëŸ¬ ì´ë¯¸ì§€ ë“œë˜ê·¸ ëŒ€ì‘)
        const directFiles = Array.from(dt.files || []).filter(isImageFile);
        collected.push(...directFiles);

        // 2ï¸âƒ£ itemsë¡œ í´ë” ì¬ê·€ ì²˜ë¦¬
        if (dt.items) {
          for (const item of dt.items) {
            const entry = item.webkitGetAsEntry?.();
            if (entry && entry.isDirectory) {
              await traverseEntry(entry, collected);
            }
          }
        }

        if (!collected.length) {
          notice.innerText = "â—ì´ë¯¸ì§€ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.";
          notice.style.color = "#dc2626";
          return;
        }

        await processFiles(collected);
      });

      /* ================= ì´ˆê¸° ================= */
      document.addEventListener("DOMContentLoaded", () => {
        renderMetrics();
        updateHistoryVisibility(); // â­ ì¶”ê°€
      });

      function resetArduino() {
        hideAnalyzeButton();
        fetch("/arduino_reset", { method: "POST" });
      }
    </script>
  </body>
</html>
